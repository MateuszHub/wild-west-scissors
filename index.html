<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Wild West Scissors</title>
  <style>
    body {
      background: #1e1e1e;
      color: white;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    canvas {
      display: block;
      margin: 20px auto;
      background: #2c3e50;
      border: 2px solid #34495e;
    }
  </style>
</head>
<body>
  <h1>Wild West Scissors</h1>
  <canvas id="gameCanvas" width="600" height="400"></canvas>

  <script src="menu.js"></script>
  <script src="battle.js"></script>
  <script src="choice.js"></script>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // Game states
    const STATES = {
      START: "start",
      BATTLE: "battle",
      POST_BATTLE: "postBattle",
      OVER: "over"
    };

    // Enemy queue with varying health
    const enemies = [
      { name: "Bandit", health: 15 },
      { name: "Outlaw", health: 25 },
      { name: "Gunslinger", health: 30 }
    ];

    let gameState = STATES.START;
    let resultText = "";
    let timeLeft = 5;
    let timerId = null;
    let computerChoice = null;
    let animationInterval = null;
    let playerHealth = 100;
    let currentEnemy = 0;

    function startGame() {
      gameState = STATES.BATTLE;
      timeLeft = 5;
      resultText = `Battle vs ${enemies[currentEnemy].name} (${enemies[currentEnemy].health} HP) - Wybierz ruch (1-2-3)`;
      startTimer();
      startComputerAnimation();
      draw();
    }

    function startComputerAnimation() {
      let frame = 0;
      animationInterval = setInterval(() => {
        computerChoice = battle.choices[frame % battle.choices.length];
        frame++;
        draw();
      }, 200);
    }

    function completeBattle(playerChoice) {
      clearInterval(animationInterval);
      computerChoice = battle.getComputerChoice();
      draw();
      
      setTimeout(() => {
        const result = battle.getResult(playerChoice, computerChoice);
        updateHealth(result);
        resultText = `Ty: ${battle.labels[playerChoice]}, ${enemies[currentEnemy].name}: ${battle.labels[computerChoice]} — ${result}`;
        
        if (playerHealth <= 0) {
          gameState = STATES.OVER;
          resultText = "Game Over! Przegrałeś!";
        } else if (enemies[currentEnemy].health <= 0) {
          currentEnemy++;
          if (currentEnemy >= enemies.length) {
            gameState = STATES.OVER;
            resultText = "Pokonałeś wszystkich przeciwników!";
          } else {
            gameState = STATES.POST_BATTLE;
          }
        } else {
          // Continue battle
          startGame();
          return;
        }
        draw();
      }, 1000);
    }

    function updateHealth(result) {
      if (result === "Przegrałeś!") {
        playerHealth -= 25;
      } else if (result === "Wygrałeś!") {
        enemies[currentEnemy].health -= 10;
      }
    }

    function startTimer() {
      if (timerId) clearInterval(timerId);
      timerId = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          completeBattle(null);
        } else {
          draw();
        }
      }, 1000);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw health bars
      drawHealthBar(50, 20, 200, 20, playerHealth, "#2ecc71", "Player");
      if (currentEnemy < enemies.length) {
        drawHealthBar(350, 20, 200, 20, enemies[currentEnemy].health, "#e74c3c", enemies[currentEnemy].name);
      }

      if (gameState === STATES.START) {
        menu.drawStartScreen(ctx);
      } 
      else if (gameState === STATES.BATTLE) {
        battle.drawBattleScreen(ctx, enemies[currentEnemy], resultText, timeLeft, computerChoice);
      }
      else if (gameState === STATES.POST_BATTLE) {
        choice.drawPostBattleScreen(ctx, enemies[currentEnemy-1], playerHealth, enemies[currentEnemy]);
      }
      else if (gameState === STATES.OVER) {
        menu.drawGameOverScreen(ctx, resultText);
      }
    }

    function drawHealthBar(x, y, width, height, value, color, label) {
      ctx.fillStyle = "#333";
      ctx.fillRect(x, y, width, height);
      
      ctx.fillStyle = color;
      ctx.fillRect(x, y, width * (value / 100), height);
      
      ctx.fillStyle = "white";
      ctx.font = "14px Arial";
      ctx.textAlign = "left";
      ctx.fillText(`${label}: ${value}%`, x + 5, y + 15);
    }

    function handlePostBattleChoice(choice) {
      if (choice === "next") {
        startGame();
      } else if (choice === "heal") {
        playerHealth = Math.min(100, playerHealth + 30);
        startGame();
      } else if (choice === "shop") {
        // TODO: Implement shop
        startGame();
      }
    }

    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      if (gameState === STATES.START) {
        // Check start button click
        if (menu.handleStartClick(mouseX, mouseY)) {
          startGame();
        }
      }
      else if (gameState === STATES.BATTLE) {
        const playerChoice = battle.handlePlayerChoice(mouseX, mouseY);
        if (playerChoice) {
          gameState = "animating";
          completeBattle(playerChoice);
        }
      }
      else if (gameState === STATES.POST_BATTLE) {
        const choiceAction = choice.handleChoiceClick(mouseX, mouseY);
        if (choiceAction) {
          handlePostBattleChoice(choiceAction);
        }
      }
      else if (gameState === STATES.OVER) {
        // Reset game
        gameState = STATES.START;
        playerHealth = 100;
        currentEnemy = 0;
        enemies.forEach((enemy, index) => {
          enemy.health = [15, 25, 30][index];
        });
        draw();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (gameState === STATES.BATTLE) {
        if (e.key === "1") {
          completeBattle("rock");
        } else if (e.key === "2") {
          completeBattle("paper");
        } else if (e.key === "3") {
          completeBattle("scissors");
        }
      }
    });

    draw();
  </script>
</body>
</html>
